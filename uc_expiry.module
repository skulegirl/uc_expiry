<?php
// $Id: uc_expiry.module,v 1.1 2009/08/13 11:15:12 theamoeba Exp $

/**
 * @file
 */

/**
 * Instance of hook_help().
 */
function uc_expiry_help($path, $arg) {
  switch ($path) {
    case "admin/help#uc_expiry":
      return "<p>". t("Displays user's role expiry date.") ."</p>";
      break;
  }
}

/**
 * Instance of hook_block_info().
 */
function uc_expiry_block_info() {
  // Need to return a list of block descriptions.
  // This is used to provide a list of possible blocks to the administrator,
  // end users will not see these descriptions.
  $blocks['uc_expiry'] = array(
    'info' => t('Displays user\'s role expiry date.'),
    'status' => TRUE,
    'weight' => 0,
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'users/*',
  );
  return $blocks;
}

function uc_expiry_block_configure($delta = '') {
  $form = array();
  if ($delta == 'uc_expiry') {
    $form['uc_expiry_post_text'] = array(
      '#type' => 'textarea',
      '#title' => t('Text to add beneath the expiry date content'),
      '#default_value' => variable_get('uc_expiry_post_text', ''),
    );
  }
  return $form;
}

function uc_expiry_block_save($delta = '', $edit = array())
{
  if ($delta == 'uc_expiry') {
    variable_set('uc_expiry_post_text', $edit['uc_expiry_post_text']);
  } 
}

/**
 * Instance of hook_block_view
 */
function uc_expiry_block_view($delta = '') {
  // Need to generate the block for display
  // purposes. The $delta parameter tells us which block is being requested.
  if ($delta == 'uc_expiry') {
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation.
      $block['subject'] = t('Account Expiry');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = uc_expiry_block_content();
  }
  return $block;
}

/**
 * uc_expiry_block_contents().
 */
function uc_expiry_block_content() {
  $uid = arg(1);
  $output = "";
  $viewed_user = user_load($uid);
  if (is_null($viewed_user))
  {
    return $output;
  }
  
  $result = db_query_range('select u.reid, u.uid, u.rid, u.expiration, u.notified from {uc_roles_expirations} u where u.uid = :uid', 0, 1, array(':uid' => $uid));

  global $user; // currently logged in user
   
  if ($user->uid == $uid)
  {
    $name = 'Your';
  }
  else
  {
    $name = $viewed_user->name . '\'s';
  }
  foreach($result as $expiry) {
    $result2 = db_query_range('select r.rid, r.name from {role} r where r.rid = :rid', 0, 1, array(':rid' => $expiry->rid));
    
    foreach ($result2 as $roles) {
      $output .= "<div class=\"uc_expiry\">";
      if (time() < $expiry->expiration) {
        $output .= t("$name account expires on ". date("F dS, Y", $expiry->expiration) .".");
      }
      else {
        $output .= t("$name account expired on ". date("F dS, Y", $expiry->expiration) .".  See all our ". l("membership options here", "membership-products") .".");
      }
      $output .= "</div>";
    }
  }
  $post_text = variable_get('uc_expiry_post_text', '');
  if (!empty($post_text))
  {
    $output .= "<div class=\"uc_expiry_post_text\">";
    $output .= filter_xss($post_text);
    $output .= "</div>";
  }
  return $output;
}
